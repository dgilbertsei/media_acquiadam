# Acquia DAM

This module provides Acquia DAM integration for Media entities (i.e. media type provider plugin). When an Acquia DAM asset is added to a piece of content, this module will create a media entity which provides a "local" copy of the asset to your site. These media entities will be periodically synchronized with Acquia DAM via cron.

## Difference from Acquia DAM Classic

The [Media: Acquia DAM module](https://www.drupal.org/project/media_acquiadam) provides similar functionality to this module for users of Acquia DAM Classic. It is important to ensure you use Media: Acquia DAM if you are a user of Acquia DAM Classic service and this module if you use the newer Acquia DAM service.

Sites which previously used Acquia DAM Classic and have migrated to the newer version of Acquia DAM can use this module to assist with the migration. See [Migrating from Acquia DAM Classic](#migrating-from-acquia-dam-classic).

## Module installation and configuration

Download and install the acquiadam module and all dependencies. [See here for help with installing modules](https://www.drupal.org/docs/extending-drupal/installing-modules).

Configuration of the module generally encompasses 5 steps:

1. [Complete the module configuration form](#global-configuration)
2. [Ensure cron tasks are running](#cron-tasks)
3. [Authenticate to the Acquia DAM service as a user](#authenticating-users)
4. [Configuring Media types](#configure-media-types)
5. (optional) [Setting up Entity Browser](#set-up-entity-browser) 

### Global configuration

Global configuration settings for the module can be found on admin/config/media/acquiadam. Most fields have reasonable defaults but two must be supplied by the site administrator:

- Acquia DAM Domain - This is the domain at which you access your DAM instance. If you don't know the correct value for this domain, file a ticket with Acquia Support and they can provide it for you.
- Acquia DAM Token - This is an API token which Drupal will use when interacting with the Acquia DAM API outside a user context (e.g., when running cron to check for updates to assets). This token can be generated by any user with administrative privileges to the DAM itself (i.e., at the domain above).

#### Cron Settings 

This module uses cron to periodically synchronize the mapped media entity field values with acquiadam. The "asset refresh interval" field allows site owners to select the _minimum_ frequency on which the API will be accessed to check for updates. The frequency is still dependent on how often the site is configured to run cron so setting a value here lower than the frequency at which the site runs cron will have no impact.

The "synchronization method" field allows site administrators to select whether all assets in Drupal are updated on every cron run or if Drupal should instead check for assets which were updated in the DAM since the last time Drupal's cron ran. 

The option for "Delete unpublished Media entities in Drupal when assets removed from the DAM" causes Drupal to delete unpublished media entities in Drupal when the DAM reports they were deleted from the DAM. If media entities which tied to assets deleted from the DAM are published in Drupal, the module instead writes a message to the site's watchdog logs

#### Image Configuration

The "Image size limit" field allows the site owner to control the maximum size of downloaded images in pixels. 

The "Image quality" field allows the site owner to control the quality of images downloaded from the DAM.

#### Manual Asset Synchronization

The configuration form includes a button to force the synchronization of all assets from the DAM. 

#### Acquia DAM Entity Browser Settings

The "Assets per page" field controls how many assets are displayed per page when using Entity Browser to select assets from the DAM. Use of Entity Browser is optional. See [below for configuration instructions](#configure-an-entity-browser-for-acquia-dam).

#### Misc.

The "Report asset usage" checkbox will send an [Integration Link](https://widenv1.docs.apiary.io/#reference/integration-links) to the DAM when a Media entity is created for an asset, allowing users of the DAM to see where assets are being used.

### Cron Tasks

The AcquiaDAM module makes use of Drupal's Queue API to process tasks asynchronously. As a result, some process needs to be configured to process the queues. Site administrators should ensure that either Drupal's core cron is being run on a frequency reasonable for their site or that separate scheduled jobs are being run to process the queues. 

The queues used by AcquiaDAM are:

- <u>acquiadam\_integration\_link\_report</u> - Used when the "Report asset usage" opten is enabled.
- <u>acquiadam\_asset\_refresh</u> - Used to fetch updates for assets which changed in the DAM.

### Authenticating Users

Drupal users who will interact with the Acquia DAM service API must authenticate to the service. This includes administrative users who will set up media types and content creators who will use the DAM to place assets in Drupal content.

To authenticate, users should go to their user edit page (/user/[uid]/edit) in Drupal and click the "Authorize with Acquia DAM." link from the Acquia DAM Authorization fieldset. User will then be directed to the configured DAM instance and prompted to login. After logging in to the DAM, users will be prompted to allow the Drupal integration access to their DAM account. On clicking "Allow", the user will be redirected back to their user page in Drupal.

#### Removing user authorization

Once a user has authenticated and allowed Drupal access to their DAM service account, the "Authorize with Acquia DAM" link on their Drupal user page will be replaced with a checkbox to "Remove Acquia DAM authorization." Ticing that box and saving will deauthorize the access token stored in Drupal for that user.

**Note**: This process not only removes the token from Drupal but also invalidates the token at the Acquia DAM service. As a result, if any other integrations are using the same token, they will fail when they next try to access the service.

### Configuring Media types

#### Recommended: 

The Acquia DAM - Example Configuration submodule will create new Media types for you with default mappings between Drupal fields and attributes from the DAM. 

#### Manual:

If you prefer not to use the Example Confuration submodule, add a new Media bundle (admin/structure/media/add) which uses "Acquia DAM Asset" as the "Media Source". This will automatically add a `field_acquiadam_asset_id` field to the Media type.

Selecting Acquia DAM Asset as the "Media Source" will also cause the form to display a Field Mapping fieldset on the Media type edit form. This allows you to map attributes from the DAM to fields on the Media type in Drupal. See [Field Mapping](#field-mapping) for more details.

**Note:** You do not necessarily _have_ to add a field to the Media type to store the DAM asset. The asset will still be fetched and stored to your local file system. However, if you do not create a field and map it to the asset from the DAM, the Media entity will actually display the asset anywhere.

**Note:** It may be desirable to create separate media bundles for different types of Acquia DAM assets (i.e. "Acquia DAM Images", "Acquia DAM Documents", "Acquia DAM videos", etc).

#### Field Mapping

**Note:** The media bundle must be saved before adding fields. More info on creating a media bundle can be found at: https://drupal-media.gitbooks.io/drupal8-guide/content/modules/media_entity/create_bundle.html

The Acquia DAM service provides **@todo** words about meta data go here, hopefully with a link to documentation.

The Acquia DAM module provides a form element which lists all the global attributes which are provided for assets, as well as client-configured metadata attributes. The Field Mapping fieldset when editing the Media type provide drop-downs for each attribute coming from the DAM service. Options within the drop downs are the fields configured within Drupal on the Media type. To map an attribute from the DAM service to a Drupal field, just select the Drupal field you want that DAM attribute to be written into. When Drupal syncs assets of that type with the DAM, the value for that attribute will populate the field in Drupal.

**Note:** By default, if you do not map the Publishing Status field in Drupal to a DAM attribute, the Media entities will be published on creation.

## Migrating from Acquia DAM Classic

When the Acquia DAM module is installed, if the Media: Acquia DAM module is already installed, Acquia DAM will uninstall the Media:Acquia DAM module (and its submodules) and update the asset_id field (`field_acquidam_asset_id`) type from an integer type to a text field, without changing the value of the field.

The Acquia DAM module also provides a means for changing the association of Media entities created using the Media: Acquia DAM module to be associated with the new Acquia DAM service (i.e., changing the values of the `field_acquiadam_asset_id` field). Prior to doing this, the assets must have been copied or moved from the Acquia DAM Classic service to the new Acquia DAM service. Then, in the Drupal administrative interface for this module, select the Migrate Assets tab (`/admin/config/media/acquiadam/migrate-assets`) and upload a CSV file containing a mapping of Asset IDs in Acquia DAM Classic to the matching Asset ID in the new Acquia DAM service.

The file must:
- contain a header row
- have a `.csv` extension
- contain one row per record of `Acquia-DAM-Classic-asset-ID, Acquia-DAM-asset-id`

<u>example CSV file</u>
```
Acquia DAM Classic ID, Acquia DAM ID
867, "a9b4127a-8393-4299-9b9e-1101c0f3b51c"
5309, "a9b4127a-8393-4299-9b9e-114x0gf4d65x"
```

#### Migrating a multisite installation  

## Drush commands provided by Acquia DAM
**@todo: List drush commands here**


**@todo: Complete editing from here down**

### Step-by-step configuration guide

This guide provides an example for how to implement the acquiadam module on your Drupal site. See [https://docs.acquia.com/dam/integrate/drupal/]() **@todo: fixthislink** for up to date information.

### Quick start configuration guide



#### Optional:



Additional fields may be added to store the Acquia DAM asset metadata. Here is a list of metadata fields which can be mapped by the "Acquia DAM Asset" type provider and the recommended field type.

- colorspace: Text -> Text (plain)
- datecaptured: General -> String
- datecaptured_date: General -> Date
- datecaptured_unix: General -> Number (integer)
- datecreated: General -> String
- datecreated_date: General -> Date
- datecreated_unix: General -> Number (integer)
- datemodified: General -> String
- datemodified_date: General -> Date
- datemodified_unix: General -> Number (integer)
- description: Text -> Text (plain)
- filename: Text -> Text (plain)
- filesize: Number -> Number (decimal)
- filetype: Text -> Text (plain)
- folderID: Number -> Number (integer)
- height: Number -> Number (integer)
- id: Number -> Number (integer)
- status: General -> Boolean
- type: Text -> Text (plain)
- type_id: Number -> Number (integer)
- version: Number -> Number (integer)
- width: Number -> Number (integer)

Additional XMP metadata field mapping options, depending on the fields enabled in Acquia DAM, will also be available (ex. city, state, customfield1 etc.)

- NOTE: Do not use the "Timestamp" field type for capturing dates. It is not meant for general data storage and will not hold the synchronized metadata.

Return to the media bundle configuration page and set the field mappings for the fields that you created. When a Acquia DAM asset is added to a piece of content, this module will create a media entity which provides a "local" copy of the asset to your site. When the media entity is created the Acquia DAM values will be mapped to the entity fields that you have configured. The mapped field values will be periodically synchronized with Acquia DAM via cron.

#### Asset status

If you want your site to reflect the Acquia DAM asset status you should map the "Status" field to "Publishing status" in the media bundle configuration. This will set the published value (i.e. status) on the media entity that gets created when a Acquia DAM asset is added to a piece of content. This module uses cron to periodically synchronize the mapped media entity field values with acquiadam.

- NOTE: If you are using the asset expiration feature in Acquia DAM, be aware that that the published status will not get updated in Drupal until the next time that cron runs (after the asset has expired in Acquia DAM).
- (2017-09-26) When an inactive asset is synchronized the entity status will show blank because of [this issue](https://www.drupal.org/node/2855630)

#### Date created and date modified

If you want your site to reflect the Acquia DAM values for when the asset was created or modified you should map the "Date created" field to the "Created" and the "Date modified" field to "Changed" in the media bundle configuration. This will set the "created" and "changed" values on the media entity that gets created when a Acquia DAM asset is added to a piece of content. This module uses cron to periodically synchronize the mapped media entity field values with Acquia DAM.



#### Crop configuration
If you are using the [Crop](https://www.drupal.org/project/crop) module on your site, you should map the "Crop configuration -> Image field" to the field that you created to store the Acquia DAM asset file.

### Configure an Entity Browser for Acquia DAM
In order to use the Acquia DAM asset browser you will need to create a new entity browser or add a Acquia DAM widget to an existing entity browser (/admin/config/content/entity_browser).

- NOTE: For more information on entity browser configuration please see the [Entity Browser](https://www.drupal.org/project/entity_browser) module and the [documentation](https://github.com/drupal-media/d8-guide/blob/master/modules/entity_browser/inline_entity_form.md) page on github
- NOTE: When editing and/or creating an entity browser, be aware that the "Modal" Display plugin is not compatible with the WYSIWYG media embed button.
- NOTE: When using the "Modal" Display plugin you may want to disable the "Auto open entity browser" setting.

### Add a media field
In order to add a Acquia DAM asset to a piece of content you will need to add a media field to one of your content types.

- NOTE: For more information on media fields please see the [Media Entity](https://www.drupal.org/project/media_entity) module and the [Drupal 8 Media Guide](https://drupal-media.gitbooks.io/drupal8-guide/content/modules/media_entity/intro.html)
- NOTE: The default display mode for media fields will only show a the media entity label. If you are using a media field for images you will likely want to change this under the display settings (Manage Display).

### WYSIWYG configuration
The media entity module provides a default embed button which can be configured at /admin/config/content/embed. It can be configured to use a specific entity browser and allow for different display modes.

- NOTE: When choosing an entity browser to use for the media embed button, be aware that the "Modal" Display plugin is not compatible with the WYSIWYG media embed button. You may want to use the "iFrame" display plugin or create a separate Entity Browser to use with the media embed button

### Acquia DAM Usage Report
For a usage report, enable the acquiadam_report module. This report provides a count of media referenced by other entities (nodes, blocks, etc.) as well as links back to the Acquia DAM asset source.

The usage report can be accessed beneath the Media tab at /admin/content/media or directly via /acquiadam/asset/report.

This module depends on the entity_usage module for it's media use count and references. For configuration options, refer to the entity_usage documentation: https://www.drupal.org/docs/8/modules/entity-usage.

- NOTE: Usage count currently includes revisions. A node, with versioning enabled and a media item attached to it, will display a use count for each revision that references the media item. Track the discussion and improvements to this behavior here: https://www.drupal.org/project/entity_usage/issues/2952210

Project page: http://drupal.org/project/acquiadam

## TODO Items
@todo: Wildcat. Remove the lightning_acquiadam submodule.

## Notes

- NOTE: Acquia DAM asset files are downloaded locally when they are added to a piece of content. Therefore you may want to [configure private file storage](https://www.drupal.org/docs/8/core/modules/file/overview) for your site in order to prevent direct access.

- NOTE: It is not recommended to "Enable display field" for the file field as this currently causes new entities to be "Not Published" by default regardless of the "Files displayed by default" setting.

- NOTE: You must configure the list of allowed file types for this field which will be specific to this media bundle. Therefore you can create separate media bundles for different types of Acquia DAM assets (i.e. "Acquia DAM Images", "Acquia DAM Documents", "Acquia DAM videos", etc).
